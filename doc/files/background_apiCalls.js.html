<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>background/apiCalls.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/EEXCESS.model.common.html">EEXCESS.model.common</a></li>
                                <li><a href="../classes/EEXCESS.model.constants.html">EEXCESS.model.constants</a></li>
                                <li><a href="../classes/EEXCESS.model.interests.html">EEXCESS.model.interests</a></li>
                                <li><a href="../classes/EEXCESS.model.languages.html">EEXCESS.model.languages</a></li>
                                <li><a href="../classes/EEXCESS.model.obfuscation.html">EEXCESS.model.obfuscation</a></li>
                                <li><a href="../classes/EEXCESS.model.policy.html">EEXCESS.model.policy</a></li>
                                <li><a href="../classes/EEXCESS.model.profile.html">EEXCESS.model.profile</a></li>
                                <li><a href="../classes/EEXCESS.model.storage.html">EEXCESS.model.storage</a></li>
                                <li><a href="../classes/EEXCESS.model.util-html.html">EEXCESS.model.util-html</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: background/apiCalls.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Extend the String object with a &#x27;startsWith&#x27; method
 */
if (typeof String.prototype.startsWith !== &#x27;function&#x27;) {
    /**
     * Checks, if a string-object starts with the provided term
     * @global
     * @param {String} str the term to check
     * @returns {Boolean} true, if the string starts with the provided term, otherwise false
     */
    String.prototype.startsWith = function(str) {
        return this.slice(0, str.length) === str;
    };
}

var EEXCESS = EEXCESS || {};

EEXCESS.qXHR;

/**
 * Sends a query with the specified parameters to europeana and hands the results
 * to the success callback or the error message to the error callback.
 * @memberOf EEXCESS
 * @param {Object} queryData data containing the weighted query terms in queryData[&#x27;terms&#x27;] and the reason for the query in queryData[&#x27;reason&#x27;]. The function accepts only a list of weighted query terms as well.
 * @param {Integer} start Item in the results to start with (first item is 1)
 * @param {querySuccess} success callback on success, receives the retrieved results as parameter
 * @param {queryError} error callback on error, receives the error message as parameter
 */
EEXCESS.euCall = function(queryData, start, numResults, success, error) {
    var weightedTerms;
    if (queryData.hasOwnProperty(&#x27;reason&#x27;)) {
        weightedTerms = queryData[&#x27;terms&#x27;];
    } else {
        weightedTerms = queryData;
    }
    var query = &#x27;&#x27;;
    for (i = 0; i &lt; 3; i++) {
        if (typeof weightedTerms[i] !== &#x27;undefined&#x27;) {
            query += weightedTerms[i].text + &#x27; &#x27;;
        } else {
            break;
        }
    }
    var x = [];
    console.log(typeof x);
    var _facets = function(item) {
        var facet_list = {};
        var facets = [
            &#x27;type&#x27;,
            &#x27;subject&#x27;,
            &#x27;year&#x27;,
            &#x27;language&#x27;,
            &#x27;provider&#x27;,
            &#x27;contributor&#x27;,
            &#x27;dataProvider&#x27;,
            &#x27;rights&#x27;,
            &#x27;ugc&#x27;,
            &#x27;usertags&#x27;
        ];
        for (var i = 0, len = facets.length; i &lt; len; i++) {
            var key = facets[i];
            if (typeof item[key] !== &quot;undefined&quot;) {
                if (typeof item[key] === &quot;object&quot;) {
                    facet_list[key] = item[key][0];
                } else {
                    facet_list[key] = item[key];
                }
            }
        }
        return facet_list;
    };
    console.log(&#x27;query: &#x27; + query + &#x27; start:&#x27; + start);
    if (EEXCESS.qXHR &amp;&amp; EEXCESS.qXHR.readystate !== 4) {
        EEXCESS.qXHR.abort();
    }
    EEXCESS.qXHR = $.ajax(EEXCESS.backend.getURL()
            + &#x27;&amp;query=&#x27; + query
            + &#x27;&amp;start=&#x27; + start
            + &#x27;&amp;rows=96&amp;profile=standard&#x27;);
    EEXCESS.qXHR.done(function(data) {
        console.log(data);
        if (data.totalResults !== 0) {
            $.map(data.items, function(n, i) {
                n.uri = n.guid;
                n.previewImage = n.edmPreview;
                delete n.edmPreview;
            });
            data.results = data.items;
            delete data.items;
            for (var i = 0, len = data.results.length; i &lt; len; i++) {
                data.results[i].facets = _facets(data.results[i]);
                data.results[i].facets.provider = &#x27;Europeana&#x27;;
                if (data.results[i].title instanceof Array) {
                    data.results[i].title = data.results[i].title[0];
                }
            }
        } else {
            data.results = [];
        }
        console.log(data);
        success(data);
    });
    EEXCESS.qXHR.fail(function(jqxhr, textStatus, errorThrown) {
        if(textStatus !== &#x27;abort&#x27;) {
            console.log(jqxhr);
            console.log(textStatus);
            console.log(errorThrown);
            error(textStatus);
        } 
    });
};

/**
 * Sends a query with the specified parameters to an API-endpoint
 * @param {Object} queryData either the weighted query terms directly or containing the weighted query terms in &quot;terms&quot; and a reason for the query in &quot;reason&quot; 
 * @param {Integer} start pagination index to start with in the result list
 * @param {Function} success success callback, receives the retrieved results as parameter
 * @param {Function} error error callback, receives the error message as parameter
 */
EEXCESS.frCall_impl = function(queryData, start, numResults, success, error) {
    var weightedTerms;
    if (queryData.hasOwnProperty(&#x27;reason&#x27;)) {
        weightedTerms = queryData[&#x27;terms&#x27;];
    } else {
        weightedTerms = queryData;
    }
    EEXCESS.profile.getProfile(function(profile) {
        profile[&#x27;contextKeywords&#x27;] = weightedTerms;
        var q = &#x27;&#x27;;
        for (var i = 0; i &lt; weightedTerms.length; i++) {
            q += weightedTerms[i].text;
        }
        profile[&#x27;queryID&#x27;] = &#x27;&#x27; + EEXCESS.djb2Code(q) + new Date().getTime();
        profile[&#x27;numResults&#x27;] = numResults;

        if (queryData.hasOwnProperty(&#x27;reason&#x27;)) {
            profile[&#x27;context&#x27;] = queryData[&#x27;reason&#x27;];
            // apply query context policy
            if (profile[&#x27;context&#x27;][&#x27;reason&#x27;] === &#x27;page&#x27; &amp;&amp; JSON.parse(EEXCESS.storage.local(&quot;privacy.policy.searchContextPage&quot;)) !== 1) {
                profile[&#x27;context&#x27;][&#x27;value&#x27;] = &#x27;disabled&#x27;;
            }
        }
        if (EEXCESS.qXHR &amp;&amp; EEXCESS.qXHR.readystate !== 4) {
            EEXCESS.qXHR.abort();
        }
        EEXCESS.qXHR = $.ajax({
            url: EEXCESS.backend.getURL(),
            data: JSON.stringify(profile),
            type: &#x27;POST&#x27;,
            contentType: &#x27;application/json; charset=UTF-8&#x27;,
            dataType: &#x27;json&#x27;,
            timeout: EEXCESS.config.TIMEOUT()
        });
        EEXCESS.qXHR.done(function(data) {
            console.log(data);
            data[&#x27;results&#x27;] = data[&#x27;result&#x27;];
            delete data[&#x27;result&#x27;];
            success(data);
        });
        EEXCESS.qXHR.fail(function(jqXHR, textStatus, errorThrown) {
            if(textStatus !== &#x27;abort&#x27;) {
            console.log(jqXHR);
            console.log(textStatus);
            console.log(errorThrown);
            error(textStatus);
            }
        });
    });
};


// set provider call function and url according to the provided value 
// if an inappropriate value is given, set it to fr-stable
EEXCESS.backend = (function() {
    var call = EEXCESS.frCall_impl;
    var url = &#x27;http://eexcess.joanneum.at/eexcess-privacy-proxy/api/v1/recommend&#x27;;
    var fr_url = &#x27;http://eexcess.joanneum.at/eexcess-privacy-proxy/api/v1/recommend&#x27;;
    var backend = &#x27;fr-stable&#x27;;
	return {
        setProvider: function(tabID, provider) {
            backend = provider;
            EEXCESS.storage.local(&#x27;backend&#x27;, provider);
            switch (provider) {
                case &#x27;eu&#x27;:
                    console.log(&#x27;eu&#x27;);
                    call = EEXCESS.euCall;
                    url = &#x27;http://europeana.eu/api//v2/search.json?wskey=HT6JwVWha&#x27;;
                    break;
                case &#x27;fr-devel&#x27;:
                    console.log(&#x27;fr-devel&#x27;);
                    call = EEXCESS.frCall_impl;
                    url = &#x27;http://eexcess-dev.joanneum.at/eexcess-privacy-proxy/api/v1/recommend&#x27;;
                    break;
                case &#x27;fr-stable&#x27;:
                    console.log(&#x27;fr-stable&#x27;);
                    call = EEXCESS.frCall_impl;
                    url = &#x27;http://eexcess.joanneum.at/eexcess-privacy-proxy/api/v1/recommend&#x27;;
                    break;
                case &#x27;self&#x27;:
                    console.log(&#x27;self&#x27;);
                    call = EEXCESS.frCall_impl;
                    url = &#x27;http://eexcess.joanneum.at/eexcess-privacy-proxy/api/v1/recommend&#x27;;
                    fr_url = url;
                    var local_url = EEXCESS.storage.local(&#x27;local_url&#x27;);
                    if (typeof local_url !== &#x27;undefined&#x27; &amp;&amp; local_url !== null) {
                        url = local_url;
                    }
                    var local_fr_url = EEXCESS.storage.local(&#x27;federated_url&#x27;);
                    if (typeof local_fr_url !== &#x27;undefined&#x27; &amp;&amp; local_fr_url !== null) {
                        fr_url = local_fr_url;
                    }
            }
        },
        setURL: function(tabID, urls) {
            EEXCESS.storage.local(&#x27;local_url&#x27;, urls.pp);
            EEXCESS.storage.local(&#x27;federated_url&#x27;, urls.fr);
            url = urls.pp;
            fr_url = urls.fr;
        },
        getURL: function() {
            if (backend === &#x27;self&#x27;) {
                return (url + &#x27;?fr_url=&#x27; + fr_url);
            }
            return url;
        },
        getCall: function() {
        	console.log(&quot;HHHH&quot;);
            return call;
        }
    };
}());

// retrieve provider from local storage or set it to &#x27;fr-stable&#x27;
if (typeof EEXCESS.storage.local(&#x27;backend&#x27;) !== &#x27;undefined&#x27;) {
    EEXCESS.backend.setProvider(-1, EEXCESS.storage.local(&#x27;backend&#x27;));
} else {
    EEXCESS.backend.setProvider(-1, &#x27;fr-stable&#x27;);
}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
