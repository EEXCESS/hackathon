<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>common_js/searchResultList.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/EEXCESS.model.common.html">EEXCESS.model.common</a></li>
                                <li><a href="../classes/EEXCESS.model.constants.html">EEXCESS.model.constants</a></li>
                                <li><a href="../classes/EEXCESS.model.interests.html">EEXCESS.model.interests</a></li>
                                <li><a href="../classes/EEXCESS.model.languages.html">EEXCESS.model.languages</a></li>
                                <li><a href="../classes/EEXCESS.model.obfuscation.html">EEXCESS.model.obfuscation</a></li>
                                <li><a href="../classes/EEXCESS.model.policy.html">EEXCESS.model.policy</a></li>
                                <li><a href="../classes/EEXCESS.model.profile.html">EEXCESS.model.profile</a></li>
                                <li><a href="../classes/EEXCESS.model.storage.html">EEXCESS.model.storage</a></li>
                                <li><a href="../classes/EEXCESS.model.util-html.html">EEXCESS.model.util-html</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: common_js/searchResultList.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var EEXCESS = EEXCESS || {};

/**
 * Implements a search result list, which can be used by all components.
 * The list updates itself, if a new query was issued and new results arrive.
 * Ratings are updated as well.
 * Required libs:
 * - jquery
 * - jquery.raty
 * - jquery-ui
 * Required css-files:
 * - eexcess.css
 * - searchResultList.css
 * - jquery-ui.css
 * Handlers for preview and rating can be customized via options, as well as the
 * path to the media folder and the path to the libs folder
 * 
 * See an usage example in /usage_examples searchResultList.js and searchResultList.html
 * @param {Jquery div elmeent} divContainer
 * @param {Object} options
 */
EEXCESS.searchResultList = function(divContainer, options) {

    /**
     * Event handler on the pagination buttons
     * 
     */

    $(document).on(&#x27;click&#x27;, &#x27;.page&#x27;, function() {
        $(&#x27;.page.active&#x27;).removeClass(&#x27;active&#x27;);
        $(this).addClass(&#x27;active&#x27;);
        var page = parseInt($(this).html()) - 1;
        var min = page * settings.itemsShown;
        var max = min + settings.itemsShown;

        $(&quot;#recommendationList li&quot;).hide().slice(min, max).show();
    })

    var settings = $.extend({
        pathToMedia: &#x27;../media/&#x27;,
        pathToLibs: &#x27;../libs/&#x27;,
        itemsShown: null,
        previewHandler: function(url) {
            window.open(url, &#x27;_blank&#x27;);
            EEXCESS.messaging.callBG({method: {parent: &#x27;model&#x27;, func: &#x27;resultOpened&#x27;}, data: url});
        },
        ratingHandler: function(uri, score, pos) {
            EEXCESS.messaging.callBG({
                method: {parent: &#x27;model&#x27;, func: &#x27;rating&#x27;},
                data: {
                    uri: uri,
                    score: score,
                    pos: pos,
                    beenRecommended: true
                }});
        }
    }, options);
    var _loader = $(&#x27;&lt;div class=&quot;eexcess_loading&quot; style=&quot;display:none&quot;&gt;&lt;img src=&quot;&#x27; + settings.pathToMedia + &#x27;loading.gif&quot; /&gt;&lt;/div&gt;&#x27;);
    var _list = $(&#x27;&lt;ul id=&quot;recommendationList&quot; class=&quot;block_list&quot; data-total=&quot;0&quot;&gt;&lt;/ul&gt;&#x27;).append($(&#x27;&lt;li&gt;no results&lt;/li&gt;&#x27;));
    var _dialog = $(&#x27;&lt;div style=&quot;display:none&quot;&gt;&lt;div&gt;&#x27;).append(&#x27;&lt;p&gt;&lt;/p&gt;&#x27;);
    var _error = $(&#x27;&lt;p style=&quot;display:none&quot;&gt;sorry, something went wrong...&lt;/p&gt;&#x27;);

    var _link = function(url, img, title) {
        var link = $(&#x27;&lt;a href=&quot;&#x27; + url + &#x27;&quot;&gt;&#x27; + title + &#x27;&lt;/a&gt;&#x27;);
        link.click(function(evt) {
            evt.preventDefault();
            settings.previewHandler(url);
        });
        _thumbnail(link, img);
        return link;
    };
    var _thumbnail = function(link, img) {
        // thumbnail on hover
        var xOffset = 10;
        var yOffset = 30;
        link.hover(
                function(e) {
                    $(&#x27;#eexcess_thumb_img&#x27;).attr(&#x27;src&#x27;, img);
                    $(&#x27;#eexcess_thumb&#x27;)
                            .css(&#x27;position&#x27;, &#x27;absolute&#x27;)
                            .css(&#x27;top&#x27;, (e.pageY - xOffset) + &#x27;px&#x27;)
                            .css(&#x27;left&#x27;, (e.pageX + yOffset) + &#x27;px&#x27;)
                            .css(&#x27;z-index&#x27;, 9999)
                            .show();
                },
                function() {
                    $(&#x27;#eexcess_thumb&#x27;).hide();
                });
        link.mousemove(function(e) {
            $(&#x27;#eexcess_thumb&#x27;)
                    .css(&#x27;top&#x27;, (e.pageY - xOffset) + &#x27;px&#x27;)
                    .css(&#x27;left&#x27;, (e.pageX + yOffset) + &#x27;px&#x27;);
        });
    };
    var _rating = function(element, uri, score) {
        element.raty({
            score: score,
            path: settings.pathToLibs + &#x27;rating/img&#x27;,
            number: 2,
            width: false,
            iconRange: [
                {range: 1, on: &#x27;thumb_down-on.png&#x27;, off: &#x27;thumb_down-off.png&#x27;},
                {range: 2, on: &#x27;thumb_up-on.png&#x27;, off: &#x27;thumb_up-off.png&#x27;}
            ],
            hints: [&#x27;bad&#x27;, &#x27;good&#x27;],
            single: true,
            click: function(score, evt) {
                settings.ratingHandler(this.uri, score, this.element.data(&#x27;pos&#x27;));
            }.bind({uri: uri, element: element})
        });
    };

    // init
    $(&#x27;body&#x27;).append(&#x27;&lt;p id=&quot;eexcess_thumb&quot; style=&quot;display:none;&quot;&gt;&lt;img id=&quot;eexcess_thumb_img&quot; alt=&quot;img preview&quot; /&gt;&lt;/p&gt;&#x27;);
    divContainer.append(_loader);
    divContainer.append(_dialog);
    divContainer.append(_list);
    divContainer.append(_error);

    // obtain current results
    EEXCESS.messaging.callBG({method: {parent: &#x27;model&#x27;, func: &#x27;getResults&#x27;}, data: null}, function(reqResult) {
        showResults(reqResult);
    });

    // listen for updates
    EEXCESS.messaging.listener(
            function(request, sender, sendResponse) {
                if (request.method.parent === &#x27;results&#x27;) {
                    if (request.method.func === &#x27;rating&#x27;) {
                        _rating($(&#x27;.eexcess_raty[data-uri=&quot;&#x27; + request.data.uri + &#x27;&quot;]&#x27;), request.data.uri, request.data.score);
                    } else if (request.method.func === &#x27;error&#x27;) {
                        _showError(request.data);
                    }
                }
                if (request.method === &#x27;newSearchTriggered&#x27;) {
                    showResults(request.data);
                } else if (request.method === &#x27;loading&#x27;) {
                    _loading();
                }
            }
    );

    var showResults = function(data) {
        _error.hide();
        _loader.hide();
        data = data.results || null;
        _list.empty();

        if (data === null || data.totalResults === 0 || data.totalResults === &#x27;0&#x27;) {
            _list.append($(&#x27;&lt;li&gt;no results&lt;/li&gt;&#x27;));
            return;
        }
        _list.attr(&#x27;data-total&#x27;, data.totalResults);
        moreResults(data.results);
        
        var height = (window.innerHeight || document.body.clientHeight) - 250;
        settings.itemsShown = Math.floor(height / 50);


        var _pagination = $(&#x27;&lt;div class=&quot;pagination&quot;&gt;&lt;/div&gt;&#x27;);
        var pages = (Math.ceil(data.results.length / settings.itemsShown) &gt; 10) ? 10 : Math.ceil(data.results.length / settings.itemsShown);
        if(pages &gt; 1) {
            for (var i = 1; i &lt;= pages; i++) {
            var _btn = $(&#x27;&lt;a href=&quot;#&quot; class=&quot;page gradient&quot;&gt;&#x27; + i + &#x27;&lt;/a&gt;&#x27;);
            if (i == 1) {
                _btn.addClass(&#x27;active&#x27;);
            }
            _pagination.append(_btn);
            }

            if (divContainer.find(&#x27;.pagination&#x27;).length != 0) {
                divContainer.find(&#x27;.pagination&#x27;).remove();
            }

            divContainer.append(_pagination)  
        }
    };
    var moreResults = function(items) {
//            $(&#x27;#eexcess_content&#x27;).unbind(&#x27;scroll&#x27;); TODO: check scrolling...
        var offset = _list.children(&#x27;li&#x27;).length;
        for (var i = 0, len = items.length; i &lt; len; i++) {

            var item = items[i];
            var img = item.previewImage;
            if (typeof img === &#x27;undefined&#x27; || img === &#x27;&#x27;) {
                img = settings.pathToMedia + &#x27;no-img.png&#x27;;
            }
            var title = item.title;

            if (typeof title === &#x27;undefined&#x27;) {
                title = &#x27;no title&#x27;;
            }
            var pos = i + offset;
            var li = $(&#x27;&lt;li data-pos=&quot;&#x27; + pos + &#x27;&quot; data-id=&quot;&#x27; + item.id + &#x27;&quot;&gt;&lt;/li&gt;&#x27;);

            _list.append(li);

            if (i &gt;= settings.itemsShown) {
                li.hide();
            }

            // rating
            var raty = $(&#x27;&lt;div class=&quot;eexcess_raty&quot;  data-uri=&quot;&#x27; + item.uri + &#x27;&quot; data-pos=&quot;&#x27; + pos + &#x27;&quot;&gt;&lt;/div&#x27;);
            _rating(raty, item.uri, item.rating);
            li.append(raty);

            var containerL = $(&#x27;&lt;div class=&quot;resCtL&quot;&gt;&lt;/div&gt;&#x27;);
            li.append(containerL);
            containerL.append(_link(item.uri, img, &#x27;&lt;img class=&quot;eexcess_previewIMG&quot; src=&quot;&#x27; + img + &#x27;&quot; /&gt;&#x27;));

            // contents
            var resCt = $(&#x27;&lt;div class=&quot;eexcess_resContainer&quot;&gt;&lt;/div&gt;&#x27;);
            resCt.append(_link(item.uri, img, title));
            li.append(resCt);

            // partner icon and name
            if (typeof item.facets.provider !== &#x27;undefined&#x27;) {
                var providerName = item.facets.provider.charAt(0).toUpperCase() + item.facets.provider.slice(1);
                containerL.append($(&#x27;&lt;img alt=&quot;provided by &#x27; + providerName + &#x27;&quot; title=&quot;provided by &#x27; + providerName + &#x27;&quot; src=&quot;&#x27; + settings.pathToMedia + &#x27;icons/&#x27; + item.facets.provider + &#x27;-favicon.ico&quot; class=&quot;partner_icon&quot; /&gt;&#x27;));
            }

            // show link
            var linkCopy = $(&#x27;&lt;a href=&quot;&quot; title=&quot;show URL of the resource&quot;&gt;&lt;img src=&quot;&#x27; + settings.pathToMedia + &#x27;icons/link.png&quot; /&gt;&lt;/a&gt;&#x27;);
            linkCopy.click(function(evt) {
                evt.preventDefault();
                _dialog.children(&#x27;p&#x27;).text(this);
                var at = &#x27;center top+&#x27; + evt.pageY;
                _dialog.dialog({
                    title: &#x27;URL of the resource&#x27;,
                    height: 130,
                    position: {my: &quot;center&quot;, at: at}
                });
                // select the link
                var selection = window.getSelection();
                var range = document.createRange();
                range.selectNodeContents(_dialog.children(&#x27;p&#x27;).get()[0]);
                selection.removeAllRanges();
                selection.addRange(range);
            }.bind(item.uri));
            containerL.append(linkCopy);

            // description
            if (typeof item.description !== &#x27;undefined&#x27; &amp;&amp; item.description !== &#x27;&#x27;) {
                var shortDescription = shortenDescription(item.description);
//                resCt.append($(&#x27;&lt;p class=&quot;result_description&quot;&gt;&#x27; + item.description + &#x27;&lt;/p&gt;&#x27;));
                resCt.append($(&#x27;&lt;p class=&quot;result_description&quot;&gt;&#x27; + shortDescription + &#x27;&lt;/p&gt;&#x27;));
            }
            resCt.append($(&#x27;&lt;p style=&quot;clear:both;&quot;&gt;&lt;/p&gt;&#x27;));

        }
//            $(&#x27;#eexcess_loading&#x27;).remove(); TODO: loading functionality
//            TODO: scrolling stuff...
//            if ($(&#x27;#eexcess_resultList&#x27;).data(&#x27;total&#x27;) &gt; $(&#x27;#eexcess_resultList li&#x27;).length) {
//                $(&#x27;#eexcess_content&#x27;).scroll(function() {
//                    EEXCESS.scrollalert(true);
//                });
//            } else {
//                $(&#x27;#eexcess_content&#x27;).scroll(function() {
//                    EEXCESS.scrollalert(false);
//                });
//            }
    };
    var shortenDescription = function(description) {

        var firstPart = description.substring(0, 100);
        var remainder = description.substring(100, description.length);
        var endPos = remainder.search(/[.!?; ]/);
        if (endPos != -1) {
            firstPart += remainder.substring(0, endPos);
            firstPart += &quot;...&quot;;
        }
        return firstPart;
    };

    var _showError = function(errorData) {
        divContainer.find(&#x27;.pagination&#x27;).remove();
        _list.empty();
        _loader.hide();
        if(errorData.msg === &#x27;timeout&#x27;) {
            _error.text(&#x27;Sorry, the server takes too long to respond. Please try again later&#x27;);
        } else {
            _error.text(&#x27;Sorry, something went wrong&#x27;);
        }
        _error.show();
        $(&#x27;#eexcess_thumb&#x27;).hide();
    };

    var _loading = function() {
        $(&#x27;#eexcess_thumb&#x27;).hide();
        divContainer.find(&#x27;.pagination&#x27;).remove();
        _error.hide();
        _list.empty();
        _loader.show();
    };

    return {
        showResults: showResults,
        loading: _loading
    };
};


    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
