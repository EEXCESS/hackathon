<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>background/logging.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/EEXCESS.model.common.html">EEXCESS.model.common</a></li>
                                <li><a href="../classes/EEXCESS.model.constants.html">EEXCESS.model.constants</a></li>
                                <li><a href="../classes/EEXCESS.model.interests.html">EEXCESS.model.interests</a></li>
                                <li><a href="../classes/EEXCESS.model.languages.html">EEXCESS.model.languages</a></li>
                                <li><a href="../classes/EEXCESS.model.obfuscation.html">EEXCESS.model.obfuscation</a></li>
                                <li><a href="../classes/EEXCESS.model.policy.html">EEXCESS.model.policy</a></li>
                                <li><a href="../classes/EEXCESS.model.profile.html">EEXCESS.model.profile</a></li>
                                <li><a href="../classes/EEXCESS.model.storage.html">EEXCESS.model.storage</a></li>
                                <li><a href="../classes/EEXCESS.model.util-html.html">EEXCESS.model.util-html</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: background/logging.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Extend the String object with a &#x27;startsWith&#x27; method
 */
if (typeof String.prototype.startsWith !== &#x27;function&#x27;) {
    /**
     * Checks, if a string-object starts with the provided term
     * @global
     * @param {String} str the term to check
     * @returns {Boolean} true, if the string starts with the provided term, otherwise false
     */
    String.prototype.startsWith = function(str) {
        return this.slice(0, str.length) === str;
    };
}

var EEXCESS = EEXCESS || {};

/**
 * Encapsulates functionality for logging user actions.
 * @namespace EEXCESS.logging
 * @type {Object}
 * @returns {Object} Returns a set of functions for logging user actions
 */
EEXCESS.logging = (function() {
    return {
        /**
         * Stores recommendations which were retrieved from a partner&#x27;s datastore
         * into the database along with the context, in which the items were recommended
         * @memberOf EEXCESS.logging
         * @param {Array.&lt;Recommendation&gt;} recommendations Recommendations as returned by a query on a partner&#x27;s datastore
         * @param {Object} context The context in which the recommendations were provided (can e.g. contain a query term)
         * @param {long} timestamp The timestamp, when the recommendations were retrieved
         */
        logRecommendations: function(recommendations, context, timestamp) {
            EEXCESS.storage.storeRecommendations(recommendations, context, timestamp);
        },
        /**
         * Stores the term of a user-initiated query in the database along with its context.
         * If the user selected a piece of text for example, this is assumed to be the context.
         * @memberOf EEXCESS.logging
         * @param {Integer} tabID Identifier of the browsertab, the query was executed in
         * @param {String} query The query
         * @param {long} timestamp The timestamp, when the recommendations were retrieved
         * @param {String} suffix suffix for the object store name
         */
        logQuery: function(tabID, query, timestamp, suffix, reason) {
            /**
             * request the context from the browsertab, the query was sent and
             * execute database transaction on callback
             */
            EEXCESS.messaging.sendMsgTab(tabID, {method: &#x27;getTextualContext&#x27;}, function(data) {
                EEXCESS.storage.put(&#x27;queries&#x27; + suffix, {query: query, timestamp: timestamp, context: data});
                // log activated queries on privacy proxy
                if (suffix === &#x27;&#x27; &amp;&amp; (typeof reason === &#x27;undefined&#x27; || reason !== &#x27;manual&#x27;)) {
                    var xhr = $.ajax({
                        url: EEXCESS.config.LOG_QUERY_ACTIVATED_URI,
                        data: JSON.stringify({&quot;uuid&quot;: EEXCESS.profile.getUUID(), &quot;queryData&quot;: {query: query, timestamp: timestamp, context: data}}),
                        type: &#x27;POST&#x27;,
                        contentType: &#x27;application/json; charset=UTF-8&#x27;,
                        dataType: &#x27;json&#x27;
                    });
                }
            });
        },
        /**
         * Stores the user interaction of starting to view a recommended resource
         * @memberof EEXCESS.logging
         * @param {String} resource URI of the viewed resource
         */
        openedRecommendation: function(resource) {
            var tmp = {
                resource: resource,
                timestamp: new Date().getTime(),
                type: &#x27;view&#x27;,
                context: EEXCESS.model.getContext(),
                beenRecommended: true
            };
            EEXCESS.storage.add(&#x27;resource_relations&#x27;, tmp);
            tmp[&#x27;action&#x27;] = &#x27;result-view&#x27;;
            tmp[&#x27;uuid&#x27;] = EEXCESS.profile.getUUID();
            var xhr = $.ajax({
                url: EEXCESS.config.LOG_RVIEW_URI,
                data: JSON.stringify(tmp),
                type: &#x27;POST&#x27;,
                contentType: &#x27;application/json; charset=UTF-8&#x27;,
                dataType: &#x27;json&#x27;
            });

        },
        /**
         * Logs the duration of a user viewing a recommended resource on closing its view
         * @memberof EEXCESS.logging
         * @param {String} resource URI of the viewed resource
         */
        closedRecommendation: function(resource) {
            EEXCESS.storage.closedRecommendation(resource, function(view) {
                view[&#x27;action&#x27;] = &#x27;result-close&#x27;;
                view[&#x27;uuid&#x27;] = EEXCESS.profile.getUUID();
                var xhr = $.ajax({
                    url: EEXCESS.config.LOG_RCLOSE_URI,
                    data: JSON.stringify(view),
                    type: &#x27;POST&#x27;,
                    contentType: &#x27;application/json; charset=UTF-8&#x27;,
                    dataType: &#x27;json&#x27;
                });
            });
        }
    };
}());

/**
 * Encapsulates functionality for logging history events
 * @namespace EEXCESS.logging.history
 */
EEXCESS.logging.history = (function() {
    // represents the current visit
    var current = {
        url: &#x27;&#x27;,
        windowId: -1,
        start: 0,
        tabId: -1,
        reset: function() {
            this.url = &#x27;&#x27;;
            this.windowId = -1;
            this.start = 0;
            this.tabId = -1;
        }
    };

    /**
     * Sets the variable &#x27;current&#x27; to the current visit with the current point of
     * time as starting timestamp. If the variable already contained another visit, the
     * contained visit is stored to the database with the current point of time
     * as ending timestamp. If the current url is the same as in the &#x27;current&#x27;-
     * variable, the content of this variable remains unchanged.
     * @memberOf EEXCESS.logging.history
     * @param {String} url The url of the current visit
     * @param {Integer} windowId Identifier of the current window
     * @param {Integer} tabId Identifier of the current browsertab
     */
    var _updateChange = function(url, windowId, tabId) {
        if (current.url !== url) {
            if (current.url !== &#x27;&#x27;) {
                _updateDB({url: current.url, start: current.start, end: new Date().getTime()});
            }
            if (!url.startsWith(&#x27;chrome&#x27;) &amp;&amp; !url.startsWith(&#x27;https://www.google.de/webhp?sourceid=chrome&#x27;)) {
                current.url = url;
                current.windowId = windowId;
                current.start = new Date().getTime();
                current.tabId = tabId;
            } else {
                current.reset();
            }
        }
    };

    /**
     * Adds additional information to a visit and stores it in the database.
     * The information added covers:
     * - transition (as obtained by chrome API)
     * - chrome_visitId (a corresponding identifier in chrome&#x27;s history)
     * - referrer (url of the referrer, may be empty)
     * @memberOf EEXCESS.logging.history
     * @param {Object} item A visit item
     * @param {String} item.url The visit&#x27;s url
     * @param {Number} item.start Start of the visit in milliseconds from the epoch
     * @param {Number} item.end End of the visit in milliseconds from the epoch
     */
    var _updateDB = function(item) {
        EEXCESS.history.getVisits(item.url, function(visitItems) {
            var chromeVisit = visitItems[visitItems.length - 1];
            item.transition = chromeVisit.transition;
            item.chrome_visitId = chromeVisit.visitId;
            EEXCESS.storage.storeVisit(item, chromeVisit.referringVisitId);
        });
    };

    // update the current visit on changes in the active tab
    EEXCESS.tabs.updateListener(function(tabID, changeInfo, tab) {
        if (tab.active) {
            _updateChange(tab.url, tab.windowId, tabID);
        }
    });

    // tab activated -&gt; start of visit
    EEXCESS.tabs.activatedListener(function(activeInfo) {
        EEXCESS.tabs.get(activeInfo.tabId, function(tab) {
            _updateChange(tab.url, activeInfo.windowId, activeInfo.tabId);
        });
    });

    // update/store the current visit on changes of the window focus
    EEXCESS.windows.focusChangedListener(function(windowId) {
        if (windowId === EEXCESS.windows.WINDOW_ID_NONE &amp;&amp; current.url !== &#x27;&#x27;) {
            // window has lost focus -&gt; end of visit
            _updateDB({url: current.url, start: current.start, end: new Date().getTime()});
            current.reset();
        } else {
            // window has obtained focus -&gt; start of visit with url of currently active tab
            EEXCESS.tabs.query({currentWindow: true, active: true}, function(tabs) {
                if (tabs.length &gt; 0) {
                    _updateChange(tabs[0].url, tabs[0].windowId, tabs[0].id);
                }
            });
        }
    });

    // if removed tab corresponds to current visit -&gt; visit ended
    EEXCESS.tabs.removedListener(function(tabID) {
        if (current.tabId === tabID) {
            _updateDB({url: current.url, start: current.start, end: new Date().getTime()});
            current.reset();
        }
    });
})();




    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
