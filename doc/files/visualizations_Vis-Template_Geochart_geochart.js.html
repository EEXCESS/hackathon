<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>visualizations/Vis-Template/Geochart/geochart.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/EEXCESS.model.common.html">EEXCESS.model.common</a></li>
                                <li><a href="../classes/EEXCESS.model.constants.html">EEXCESS.model.constants</a></li>
                                <li><a href="../classes/EEXCESS.model.interests.html">EEXCESS.model.interests</a></li>
                                <li><a href="../classes/EEXCESS.model.languages.html">EEXCESS.model.languages</a></li>
                                <li><a href="../classes/EEXCESS.model.obfuscation.html">EEXCESS.model.obfuscation</a></li>
                                <li><a href="../classes/EEXCESS.model.policy.html">EEXCESS.model.policy</a></li>
                                <li><a href="../classes/EEXCESS.model.profile.html">EEXCESS.model.profile</a></li>
                                <li><a href="../classes/EEXCESS.model.storage.html">EEXCESS.model.storage</a></li>
                                <li><a href="../classes/EEXCESS.model.util-html.html">EEXCESS.model.util-html</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: visualizations/Vis-Template/Geochart/geochart.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">

function Geochart(root, visTemplate) {

	var GEO = {};
	GEO.Settings = new Settings(&#x27;geochart&#x27;);

	var Vis = visTemplate;
	var data;
    var colorScale;
    var width, height;
    var colorChannel;
    GEO.$root = $(root);
    GEO.ClusterSettings = {
        minSize:32,
        maxSize:64,
        minAmount:2,
        maxAmount:8
    };
	


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/* Event handlers  */

	GEO.Evt = {};






////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    /*  Additional methods, if necessary*/

	GEO.Internal = {

        getRandomInRange: function (from, to, fixed) {
            return (Math.random() * (to - from) + from).toFixed(fixed) * 1;
            // .toFixed() returns string, so &#x27; * 1&#x27; is a trick to convert to number
        },
        getRandomLatLon: function (i) {
            return [GEO.Internal.getRandomInRange(-20, 60, 3), GEO.Internal.getRandomInRange(-120, 120, 3)];
            //return [(20 + i).toFixed(3) * 1, (0).toFixed(3) * 1];
        },
        spatializeData: function(data){
            for(var i=0; i&lt;data.length; i++){
                if (!data[i].coordinate)
                    data[i].coordinate = GEO.Internal.getRandomLatLon(i);
            }
        },
        getDataIndex: function(id){
            for(var i=0; i&lt;GEO.Input.data.length; i++){
                if (GEO.Input.data[i].id == id)
                    return i;
            }
            return null;
        },
		getDataIndexArrayPerSelection: function(layer){
			var indexArray = [];
			var rectBounds = layer.getBounds();
			var inputData = GEO.Input.data;
		    for(var i=0; i &lt; inputData.length; i++){
				if(
                    inputData[i].coordinate &amp;&amp; inputData[i].coordinate.length == 2 &amp;&amp;
					rectBounds.getWest() &lt;= inputData[i].coordinate[1] &amp;&amp;
					inputData[i].coordinate[1] &lt;= rectBounds.getEast() &amp;&amp;
					rectBounds.getSouth() &lt;= inputData[i].coordinate[0] &amp;&amp;
					inputData[i].coordinate[0] &lt;= rectBounds.getNorth()
					)
				{
					indexArray.push(i);
				}
            }
            return indexArray;
		}
    };






////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	GEO.Render = {};



	/******************************************************************************************************************
	*
	*	Draw GEO vis
	*
	* ***************************************************************************************************************/
	GEO.Render.draw = function( receivedData, mappingCombination, iWidth, iHeight ){

		// See settings.js

		/******************************************************
		*	Define canvas dimensions
		******************************************************/
		GEO.Dimensions = GEO.Settings.getDimensions( root, iWidth, iHeight);
		width   = GEO.Dimensions.width;
		height  = GEO.Dimensions.height;
		colorScale   = d3.scale.category10();
        colorChannel = &#x27;language&#x27;;
        for(var i=0; i&lt;mappingCombination.length; i++)
            if (mappingCombination[i].visualattribute == &#x27;color&#x27;)
                colorChannel = mappingCombination[i].facet;



		/******************************************************
		*	Define input variables
		******************************************************/
		GEO.Input = GEO.Settings.getInitData(receivedData );
        GEO.Internal.spatializeData(GEO.Input.data);
        GEO.$root.append(&#x27;&lt;div id=&quot;mapInner&quot; style=&quot;height:100%&quot;&gt;&lt;/div&gt;&#x27;);

        GEO.map = L.map(&#x27;mapInner&#x27;);
        GEO.Render.centerMap();
        L.tileLayer(&#x27;http://{s}.tile.osm.org/{z}/{x}/{y}.png&#x27;, {
            attribution: &#x27;&amp;copy; &lt;a href=&quot;http://osm.org/copyright&quot;&gt;OpenStreetMap&lt;/a&gt; contributors&#x27;
        }).addTo(GEO.map);
        GEO.Render.drawMarkers();

        // Leaflet Draw
        var drawnItems = new L.FeatureGroup();
        GEO.map.addLayer(drawnItems);
		
		L.drawLocal.draw.toolbar.buttons.rectangle = &quot;selection tool&quot;;

        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems,
				edit:false,
				remove:false
            },
			draw: {
				rectangle:{
			        shapeOptions: {
						stroke: true,
						color: &#x27;#1E28EC&#x27;,
						weight: 2,
						opacity: 0.7,
						fill: true,
						fillColor: null, //same as color by default
						fillOpacity: 0.1
					}
				},
				polygon: false,
				marker: false,
				polyline: false,
				circle:false
			}
        });
		
        GEO.map.addControl(drawControl);
		
		GEO.map.on(&#x27;draw:created&#x27;, function (e) {
			var type = e.layerType,
				layer = e.layer;

			if (type === &#x27;rectangle&#x27;) {
				// Do marker specific actions
				GEO.Render.deleteCurrentSelect();
				GEO.map.addLayer(layer);
				currentOneLayer = layer;
				//make selection list
				Vis.selectItems(
					GEO.Internal.getDataIndexArrayPerSelection(layer)
				);
			}

			// Do whatever else you need to. (save to db, add to map etc)
			//GEO.map.addLayer(layer);
		});
	};
	GEO.Render.deleteCurrentSelect = function(){
		if(currentOneLayer != null &amp;&amp; GEO.map.hasLayer(currentOneLayer)){
			GEO.map.removeLayer(currentOneLayer);
			currentOneLayer = null;
		}
	};
	
    var currentOneLayer = null;
	
    GEO.Render.centerMap = function(){
        GEO.map.setView([51.505, -0.09], 2);
    };

    GEO.Render.drawMarkers = function(){

        GEO.markersGroup = new L.MarkerClusterGroup({
            iconCreateFunction: function(cluster) {
                //return new L.DivIcon({ html: &#x27;&lt;b&gt;&#x27; + cluster.getChildCount() + &#x27;&lt;/b&gt;&#x27; });
                //return new L.DivIcon({ html: &#x27;&lt;div&gt;&lt;span&gt;&#x27; + cluster.getChildCount() + &#x27;&lt;/span&gt;&lt;/div&gt;&#x27;, className: &#x27;marker-cluster&#x27;, iconSize: new L.point(40, 40) });
                //return new L.DivIcon({ className:&#x27;marker-cluster-pie&#x27;, iconSize: L.point(44, 44), html: &#x27;&lt;svg width=&quot;44&quot; height=&quot;44&quot; viewbox=&quot;0 0 400 400&quot;&gt;&lt;path d=&quot;M200,200 L200,20 A180,180 0 0,1 377,231 z&quot; style=&quot;fill:#ff0000;fill-opacity: 0.5;&quot;/&gt;&lt;path d=&quot;M200,200 L377,231 A180,180 0 0,1 138,369 z&quot; style=&quot;fill:#00ff00;fill-opacity: 0.5;&quot;/&gt;&lt;path d=&quot;M200,200 L138,369 A180,180 0 0,1 20,194 z&quot; style=&quot;fill:#0000ff;fill-opacity: 0.5;&quot;/&gt;&lt;path d=&quot;M200,200 L20,194 A180,180 0 0,1 75,71 z&quot; style=&quot;fill:#ff00ff;fill-opacity: 0.5;&quot;/&gt;&lt;path d=&quot;M200,200 L75,71 A180,180 0 0,1 200,20 z&quot; style=&quot;fill:#ffff00;fill-opacity: 0.5;&quot;/&gt;&lt;/svg&gt;&lt;div class=&quot;child-count&quot;&gt;&#x27; + cluster.getChildCount() + &#x27;&lt;/div&gt;&#x27;});

                var markers = cluster.getAllChildMarkers();
                var pieParts = {};
                for (var i=0; i&lt;markers.length; i++){
                    var dataObject = markers[i].options.dataObject;
                    if (!pieParts[dataObject.facets[colorChannel]]){
                        pieParts[dataObject.facets[colorChannel]] = 0;
                    }
                    pieParts[dataObject.facets[colorChannel]] ++;
                }
                var piePartsCountColor = [];
                for (var key in pieParts) {
                    if (pieParts.hasOwnProperty(key)){
                        piePartsCountColor.push({
                            count:pieParts[key],
                            color:colorScale(key)
                        });
                    }
                }
                var size = GEO.Render.getClusterSize(GEO.ClusterSettings, markers.length);
                var innerSize = size/2;
                var childCountStyle = &#x27;font-size:&#x27;+ (innerSize/2 + 2) +&#x27;px; border-radius: &#x27; + (innerSize/2) + &#x27;px; height: &#x27; + innerSize + &#x27;px; width: &#x27; + innerSize + &#x27;px; line-height: &#x27; + innerSize + &#x27;px; left: &#x27; + (innerSize/2) + &#x27;px; top: &#x27; + (innerSize/2) + &#x27;px;&#x27;;

                var svg = document.createElement(&quot;svg&quot;);
                GEO.Render.drawArcs(svg, piePartsCountColor);
                return new L.DivIcon({ className:&#x27;marker-cluster-pie&#x27;, iconSize: L.point(size, size), html: &#x27;&lt;svg width=&quot;&#x27; + size + &#x27;&quot; height=&quot;&#x27; + size + &#x27;&quot; viewbox=&quot;0 0 400 400&quot;&gt;&#x27; + svg.innerHTML + &#x27;&lt;/svg&gt;&lt;div class=&quot;child-count&quot; style=&quot;&#x27;+childCountStyle+&#x27;&quot;&gt;&#x27; + cluster.getChildCount() + &#x27;&lt;/div&gt;&#x27;});
            }
        });

        for(var i=0; i&lt;GEO.Input.data.length; i++){
            //var marker = L.marker(GEO.Input.data[i].coordinate);
            //var marker = L.marker([51.505, -0.09]);
            if (!GEO.Input.data[i].coordinate || GEO.Input.data[i].coordinate.length &lt; 2)
                continue;

            var currentDataObject = GEO.Input.data[i];
            currentDataObject.color = colorScale(currentDataObject.facets[colorChannel]);
            var marker = new GEO.Render.Marker(GEO.Input.data[i].coordinate, { icon: GEO.Render.icon(currentDataObject.color) });
            marker.options.dataObject = currentDataObject;
            marker.bindPopup(GEO.Input.data[i].title);
            marker.on(&#x27;click&#x27;, function(e){
                if (e &amp;&amp; e.target &amp;&amp; e.target.options &amp;&amp; e.target.options.dataObject){
					GEO.Render.deleteCurrentSelect();
                    Vis.selectItems([GEO.Internal.getDataIndex(e.target.options.dataObject.id)]);
                }
            }).on(&#x27;popupclose&#x27;, function(){
                    Vis.selectItems([]);
            });
            GEO.markersGroup.addLayer(marker);
            GEO.Input.data[i].geoMarker = marker;
        }

        GEO.map.addLayer(GEO.markersGroup);
    };

    GEO.Render.Marker = L.Marker.extend({
        options:{
            dataObject: null
        }
    });

    // credits to: https://github.com/jseppi/Leaflet.MakiMarkers
    GEO.Render.icon = function(color){
        return new L.Icon({
                //iconSize: [36,90], //l
                //popupAnchor: [0,-40], //l
                iconSize: [30,70], //m
                popupAnchor: [0,-30], //m
                iconUrl : &#x27;https://api.tiles.mapbox.com/v3/marker/pin-m+&#x27; + color.substr(1) + &#x27;.png&#x27;,
                iconRetinaUrl : &#x27;https://api.tiles.mapbox.com/v3/marker/pin-m+&#x27; + color.substr(1) + &#x27;@2x.png&#x27;
            });
    };

    // credits to: http://stackoverflow.com/questions/7261318/svg-chart-generation-in-javascript
    GEO.Render.makeSVG = function(tag, attrs) {
        var el= document.createElementNS(&#x27;http://www.w3.org/2000/svg&#x27;, tag);
        for (var k in attrs)
            if (attrs.hasOwnProperty(k)) el.setAttribute(k, attrs[k]);
        return el;
    };

    GEO.Render.getClusterSize = function(clusterSettings, markersCount){
        var divider = clusterSettings.maxAmount - clusterSettings.minAmount;
        var sizeGrowthPerMarker = (clusterSettings.maxSize - clusterSettings.minSize) / divider;
        var sizeMultiplier = markersCount - clusterSettings.minAmount;
        if (sizeMultiplier &lt; 0)
            sizeMultiplier = 0;
        if (sizeMultiplier &gt; divider)
            sizeMultiplier = divider;
        var size = clusterSettings.minSize + (sizeMultiplier * sizeGrowthPerMarker);
        size = Math.round(size/4)*4; // pixel should be able to divide without remainder
        return size;
    };

    GEO.Render.drawArcs = function(paper, piePartsCountColor){
        var total = piePartsCountColor.reduce(function (previous, current) { return previous + current.count; }, 0);
        var sectorAngleArr = piePartsCountColor.map(function (v) { return 360 * v.count / total; });
        var startAngle = 0;
        var endAngle = 0;
        for (var i=0; i&lt;sectorAngleArr.length; i++){
            startAngle = endAngle;
            endAngle = startAngle + sectorAngleArr[i];
            var x1,x2,y1,y2 ;
            x1 = parseInt(Math.round(200 + 195*Math.cos(Math.PI*startAngle/180)));
            y1 = parseInt(Math.round(200 + 195*Math.sin(Math.PI*startAngle/180)));
            x2 = parseInt(Math.round(200 + 195*Math.cos(Math.PI*endAngle/180)));
            y2 = parseInt(Math.round(200 + 195*Math.sin(Math.PI*endAngle/180)));
            var d = &quot;M200,200  L&quot; + x1 + &quot;,&quot; + y1 + &quot;  A195,195 0 &quot; + ((endAngle-startAngle &gt; 180) ? 1 : 0) + &quot;,1 &quot; + x2 + &quot;,&quot; + (y2 == 200 ? 199 : y2) + &quot; z&quot;;
            //alert(d); // enable to see coords as they are displayed
            // original:
            //var c = parseInt(i / sectorAngleArr.length * 360);
            //var arc = GEO.Render.makeSVG(&quot;path&quot;, {d: d, fill: &quot;hsl(&quot; + c + &quot;, 66%, 50%)&quot;});
            var arc = GEO.Render.makeSVG(&quot;path&quot;, {d: d, fill: piePartsCountColor[i].color,  transform : &quot;rotate(-90 200 200)&quot;});
            paper.appendChild(arc);
            //arc.onclick = clickHandler; // This is optional, of course
        }
        return paper;
    };



	/******************************************************************************************************************
	*
	*	Reset GEO  vis
	*
	* ***************************************************************************************************************/
	GEO.Render.reset = function(  ){
        GEO.map.removeLayer(GEO.markersGroup);
        GEO.Render.drawMarkers();
        GEO.Render.centerMap();
		GEO.Render.deleteCurrentSelect();
		
	};



    /******************************************************************************************************************
	*
	*	Highlight items
    *   @param indexArray: array with items&#x27; indices to highlight. They match items in receivedData (parameter in Render.draw)
	*
	* ***************************************************************************************************************/
	GEO.Render.highlightItems = function(indexArray){
        GEO.map.closePopup();
        indexArray.forEach(function(i) {
            GEO.markersGroup.zoomToShowLayer(GEO.Input.data[i].geoMarker, function() {
                GEO.Input.data[i].geoMarker.openPopup();
            });
            //GEO.Input.data[i].geoMarker.openPopup();
        });
		GEO.Render.deleteCurrentSelect();
    };


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	GEO.Ext = {
		draw: function( receivedData, mappingCombination, iWidth, iHeight ){ GEO.Render.draw(receivedData, mappingCombination, iWidth, iHeight); },
		reset: function(){ GEO.Render.reset();	},
        highlightItems: function(indexArray){ GEO.Render.highlightItems(indexArray); }
	};


	return GEO.Ext;

}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
